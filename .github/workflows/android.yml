name: Android

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout! 
      uses: actions/checkout@v1
      with:
        submodules: true

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: 2.x

    - name: Install skia host dependencies
      working-directory: ./externals/skia
      shell: bash
      run: tools/install_dependencies.sh

    - name: Sync skia third party dependencies
      working-directory: ./externals/skia
      shell: bash
      run: python tools/git-sync-deps

    - uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21d

    - run: echo ${{ steps.setup-ndk.outputs.ndk-path }}

    - name: Convert skia Build GN to CMake
      working-directory: ./externals/skia
      shell: bash
      run: bin/gn gen out/cmake --ide=json --json-ide-script=../../gn/gn_to_cmake.py --args='skia_use_system_libjpeg_turbo=false skia_use_system_libwebp=false skia_use_system_expat=false skia_use_system_libpng=false skia_use_system_freetype2=false ndk=${{ steps.setup-ndk.outputs.ndk-path }} target_os="android" target_cpu="arm" is_debug=false is_component_build=true extra_cflags=["-O3"] skia_use_angle=false skia_use_icu=false skia_use_lua=false skia_use_opencl=false skia_use_piex=false skia_use_zlib=false skia_enable_tools=false skia_enable_pdf=false skia_use_gl=true skia_enable_skottie=false'

    - name: Build with Gradle
      working-directory: ./platforms/android
      run: |
        chmod +x gradlew
        ./gradlew assemble

    - name: Archive results
      uses: actions/upload-artifact@v1
      with:
        name: android
        path: ./platforms/android/build/android-app/outputs/apk/debug